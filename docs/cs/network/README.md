- [模型分层](#模型分层)
  - [总览](#总览)
  - [数据链路层](#数据链路层)
    - [封装成帧](#封装成帧)
    - [差错检测](#差错检测)
    - [可靠性传输](#可靠性传输)
    - [媒体接入控制MAC](#媒体接入控制mac)
    - [虚拟局域网VLAN](#虚拟局域网vlan)
  - [网络层](#网络层)
    - [IP地址](#ip地址)
    - [无分类ip地址划分CIDR](#无分类ip地址划分cidr)
    - [ARP协议](#arp协议)
    - [路由信息协议RIP](#路由信息协议rip)
    - [网际控制报文协议ICMP](#网际控制报文协议icmp)
    - [VPN和NAT](#vpn和nat)
- [NAT 协议](#nat-协议)
  - [作用](#作用)

# 模型分层

## 总览

![20230418155142](https://raw.githubusercontent.com/PercivalYang/imgsSaving/main/imgs/20230418155142.png)

- 最原始的OSI模型是7层，不展开说。目前比较流行的是如图所示的4层模型，以及将数据链路层和物理层单独分开的5层模型。
- 右边的灰色框内是各层的代表协议

## 数据链路层

### 封装成帧

- `透明传输`：即对上层交付的数据没有任何限制（例如不限制不能出现与帧头帧尾相同的字节码，因为在封装前会对其进行转译）
- 帧头帧尾中包含了重要的控制信息，见下方帧格式
- `MTU(Maximum Transmission Unit)`：最大传输单元，即帧的最大长度

**帧格式**

![20230418145943](https://raw.githubusercontent.com/PercivalYang/imgsSaving/main/imgs/20230418145943.png)

- 帧头主要是`标志字段`和`协议字段`
- 帧尾主要是`CRC校验位字段`

### 差错检测

- 奇偶校验：存在漏检
- 循环冗余校验CRC(Cyclic Redundancy Check)：漏检概率小，广泛采用

### 可靠性传输

差错检测后对于错误的帧会进行重传或者丢弃，取决于是否提供可靠传输服务，例如：

- TCP和UDP
- IP向上层提供不可靠、无连接的服务
- 802.11无线局域网要求可靠传输；以太网不要求。（因为有线链路误码率较低，无线较高）

**实现机制**：

1. SW(Stop-and-Wait)停止等待协议：即发送方在发送一组数据后会等待接收方回复`ACK`标志后，在发送下一组数据。
   - 存在信道利用率低的缺点；

2. 回退N帧协议GBN(Go-Back-N)：即发送方连续发送数据分组，对数据分组进行编号；接收方会对应数组编号给`ACK`标志也加上编号，表示该编号的数据组无差错接收成功。当接收方之前发送的某个分组的数据触发`超时重传`后，发送方会将该编号之后的所有分组重新发送。这也是GBN的由来，涉及到的一些名词如下：
   - 滑动窗口(接收方窗口尺寸等于1，即按序接收)
   - 累计确认/捎带确认

3. 选择重传协议SR：在GBN之上提高了效率，接收方的窗口尺寸大于1，接收落在窗口内的发送方无差错数据分组，对于缺失的数据分组会触发发送方的超时重传。
   - 相比GBN，SR合理利用发送过来的数据分组，不再有`头个分组出错而丢弃剩下全部分组`的效率低下问题；
   - 要注意发送方和接收方的窗口尺寸大于分组序号的一半，不然会出现`新旧组无法分辨`问题

### 媒体接入控制MAC

MAC：Medium Access Control

![20230418151318](https://raw.githubusercontent.com/PercivalYang/imgsSaving/main/imgs/20230418151318.png)

**CSMA/CD**：

因为同个网络内多个节点会访问同个共享信道进行通信，为了避免多个节点同时向信道发送数据帧导致`帧碰撞`，于是就有了`CSMA/CD`

- `CSMA`可分为CS和MA进行理解
  - `CS`：Carrier Sense，载波侦听，即检测信道是否空闲
  - `MA`：Multiple Access，多路访问，即多个节点同时访问信道
- `CD`：碰撞检测，即节点边发送数据帧边检测是否发生碰撞

MAC地址：硬件地址

`单播`和`多播地址`：单播地址是指一个节点的MAC地址，多播地址是指一组节点的MAC地址

`广播帧`：目的地址为`FF:FF:FF:FF:FF:FF`的帧，广播帧会被所有节点接收

### 虚拟局域网VLAN

将局域网内的设备划分为多个**逻辑子网**，每个子网内的设备可以互相通信，但是子网之间的设备不能互相通信。

- 同一个VLAN内可以广播通信

**实现机制**

- Access端口：交换机和用户设备的连接
- Trunk端口：交换机和交换机的连接

![20230419105632](https://raw.githubusercontent.com/PercivalYang/imgsSaving/main/imgs/20230419105632.png)

实现VLAN即给Access端口和Trunk端口分配不同的PVID

## 网络层

### IP地址

**ipv4**

![20230419111607](https://raw.githubusercontent.com/PercivalYang/imgsSaving/main/imgs/20230419111607.png)

- 网络号范围
  - A类：0～127
  - B类：128～191
  - C类：192～223
  - D类：224～239
  - E类：240～255

- 网络地址不能指派给
  - A类网络号为0和127；
  - 主机号为全0（网络地址）
  - 主机号为全1（广播地址）

**子网掩码**

- 通过比特1对应网络号和子网号（**先看网络属于哪类网络，再看子网号**）
- 通过比特0对应主机号

### 无分类ip地址划分CIDR

无分类域间路由选择(Classless Inter-Domain Routing)。消除了A、B、C类和划分子网的概念。

CIDR利用`斜线法`区分主机号和网络号，例如`128.14.35.7/20`表示前20位是网络号，后12位是主机号。

**聚合网络地址(构造超网)**

通过CIDR划分的ip地址，在路由器查表时为了提高效率，会找到ip地址的共同前缀聚合成一个超网，例如：

![20230419115443](https://raw.githubusercontent.com/PercivalYang/imgsSaving/main/imgs/20230419115443.png)

### ARP协议

ARP协议帮助从ip地址转换为MAC地址，即`IP地址解析协议`。每个主机都会有一个`ARP高速缓存表`如下，用来查询ip地址和MAC地址之间的映射关系。

![20230418154344](https://raw.githubusercontent.com/PercivalYang/imgsSaving/main/imgs/20230418154344.png)

- 动态是主机运行期间通过广播自动获取的，存在生命周期；
- 静态是手动配置，即持久化存储在硬盘中。

> ARP协议不能跨网络使用，只能在同一网络内使用

`ARP请求报文(广播)`：内容抽象如下，在网络内发送广播帧来查询目标ip地址的MAC地址

![20230418154123](https://raw.githubusercontent.com/PercivalYang/imgsSaving/main/imgs/20230418154123.png)

### 路由信息协议RIP

使用`跳数`作为度量路由器到达网络的距离，其中：

- 与路由器直连的网络跳数为1(思科为0)
- 最大跳数为15(因此适用于**小型网络**)
- 非直连网络没经过一个路由器则+1
![20230420113158](https://raw.githubusercontent.com/PercivalYang/imgsSaving/main/imgs/20230420113158.png)

RIP选择路由是根据`最小跳数`来选择，与带宽无关。当到达网络有多个跳数相同的路径时，会进行`等价负载均衡`。

> 等价负载均衡在路由表中的实现即：多个跳数相同，但下一跳的路由器不同的路由条目。如下图所示![20230420113532](https://raw.githubusercontent.com/PercivalYang/imgsSaving/main/imgs/20230420113532.png)

### 网际控制报文协议ICMP

ICMP: Internet Control Message Protocol。该协议包括`差错报文`和`查询报文`。被封装在IP数据包中发送

**差错报文**

- 目的不可达
  - 包括目的主机/端口/协议/网络等不可达
- 源点抑制
  - 由于网络拥塞，路由器丢弃数据包时会向源主机发送该报文
- TTL超时
  - 当数据包在路由器中转时，每经过一个路由器TTL减1，当TTL为0时，路由器丢弃数据包并发送该报文
- 重定向
  - 当路由器发现数据包的下一跳路由器不是最优路由时，会发送该报文给源主机，告知其下一跳路由器的地址
- 参数问题
  - 当数据包的参数有误时，会发送该报文，例如传输途中发生误码

需要注意的是：

- 不发送ICMP差错报文的情况：
  - 多播地址的数据报；
  - 特殊地址如127.0.0.0或0.0.0.0；

**查询报文**

通常用来查询目标主机是否可达，例如ping(Packet InterNet Groper)命令。

### VPN和NAT

**VPN**

VPN: Virtual Private Network。虚拟专用网络。利用公网作为机构各专用网之间的通信载体。

**NAT**

NAT: Network Address Translation。网络地址转换。将内部私有地址转换为公网地址，从而实现公网访问内部网络。

但由于NAT转换的内部私有地址和公网地址要一一对应，就有了改进版的`NAPT`(Network Address and Port Translation)技术，即将内部私有地址和公网地址以及端口号一一对应。

# NAT 协议

NAT协议是一种将内部私有地址转换为公网地址的技术，从而实现公网访问内部网络的功能。

![20230525222712](https://raw.githubusercontent.com/PercivalYang/imgsSaving/main/imgs/20230525222712.png)

如上图3->4过程中，能从`138.76.29.7:5001`转换为`10.0.0.1:3345`是因为在前面的1->2过程中往路由器的NAT转换表中写入了该映射关系

## 作用

- 隐藏内部网络结构
- 提高网络安全性
