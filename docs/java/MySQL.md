# InnoDB

## 数据页

InnoDB的数据是按照「**数据页**」为单位读写，默认大小为**16KB**，包含有7个部份，如右图所示，其中：

- File Header有两个指针，分别指向上个和下个数据页，形成**双向链表**
- 数据页中的行记录按照「主键」顺序形成**单向链表**，为了提高检索效率，因此加入了「页目录」

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/14cb7f7b-d0f6-441b-8b24-08b7e46cd6a5/Untitled.png)

### 页目录

如右图所示

1. 将所有的记录划分成几个组，这些记录包括最小记录和最大记录，但**不包括标记为“已删除”的记录；**
2. 每个记录组的最后一条记录就是组内最大的那条记录，并且最后一条记录的头信息中会存储该组一共有多少条记录，作为 n_owned 字段（右图中粉红色字段）
3. 页目录用来存储**每组最后一条记录的地址偏移量**，这些地址偏移量会按照先后顺序存储起来，每组的地址偏移量也被称之为槽（slot），**每个槽相当于指针指向了不同组的最后一个记录**。

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/fb950aa2-a465-46b2-94c0-6f2ff28f6bba/Untitled.png)

# 并发事务的问题

- 脏读：一个事务「读到」了另一个**「未提交事务修改过的数据」**
- 不可重复读：在**一个事务内**多次读取同一个数据，如果出现**前后两次读到的数据不一样**的情况。
- 幻读：在一个事务内多次查询某个符合查询条件的「记录数量」，如果出现前后两次查询到的记录数量不一样的情况。

> 区分幻读和不可重复读
A：幻读是指查询的**记录数量**前后不同，不可重复读是指**具体数据值**的前后不同
> 

# 事务

## 特性

**概念：**

- **原子性（Atomicity）**：一个事务要么完成要么不完成
- **一致性（Consistency）**：是指事务操作前和操作后，数据满足完整性约束，数据库保持一致性状态。
- **隔离性（Isolation）**：每个事务都有一个完整的数据空间，对其他并发事务是隔离的。
- **持久性（Durability）**：事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。

**如何保证：**

- 持久性是通过 redo log （重做日志）来保证的；
- 原子性是通过 undo log（回滚日志） 来保证的；
- 隔离性是通过 MVCC（多版本并发控制） 或锁机制来保证的；
- 一致性则是通过持久性+原子性+隔离性来保证；

## 隔离级别

### 概念

级别越高，性能越低

- **读未提交（*read uncommitted*）：**指一个事务还没提交时，它做的变更就能被其他事务看到；
- **读提交（*read committed*）：**指一个事务提交之后，它做的变更才能被其他事务看到；
- **可重复读（*repeatable read*）：**指一个事务执行过程中看到的数据，一直跟这个事务启动时看到的数据是一致的，**MySQL InnoDB 引擎的默认隔离级别**；
- **串行化（*serializable* ）：**会对记录加上读写锁，在多个事务对这条记录进行读写操作时，如果发生了读写冲突的时候，后访问的事务必须等前一个事务执行完成，才能继续执行；

![不同隔离级别会出现的并发问题](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/395ae4c8-3988-4e29-9ea2-a022a72ecf14/Untitled.png)

不同隔离级别会出现的并发问题

### 实现

- 读未提交：不加锁直接读
- 读提交：通过**ReadView**实现，在「每个语句执行前」都重新生成一个Read View
- 可重复读：「启动事务时」生成一个Read View
- 串行化：加读写锁进行访问，同一时刻只允许一个线程读取